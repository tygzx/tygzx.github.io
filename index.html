<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="知行合一">
<meta property="og:type" content="website">
<meta property="og:title" content="tygzx 的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="tygzx 的博客">
<meta property="og:description" content="知行合一">
<meta property="article:author" content="tygzx">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>tygzx 的博客</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">tygzx 的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/07/%E6%96%87%E4%BB%B6%E5%90%88%E5%B9%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/07/%E6%96%87%E4%BB%B6%E5%90%88%E5%B9%B6/" itemprop="url">文件合并</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-07T12:41:01+08:00">
                2020-03-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近碰到如下的一个问题  如何快速合并两个大文件？</p>
<p>有A,B两个文件。这两个文件都有以下特性</p>
<ol>
<li><p>A,B两个文件每一行都可以被解析为json 格式</p>
</li>
<li><p>A,B两个文件都比较大(至少大于500M)</p>
</li>
<li><p>A,B两个文件可以通过将每行转化为json之后通过某个相同key的值合并</p>
</li>
<li><p>A文件有a行,B文件有b行</p>
</li>
<li><p>A,B两个文件两行可以合并的条件是唯一的。</p>
<blockquote>
<p>比如 A文件的第一行可以是这样的一个json </p>
<p>{</p>
<p>​    ‘id’:1,</p>
<p>​    ‘test’: 2</p>
<p>}</p>
<p>B文件的第二行可以是这样的一个json</p>
<p>{</p>
<p>  ‘id’:1,</p>
<p>  ‘test2’:3</p>
<p>}</p>
<p>我们可以通过两个相同的key合并为这样一个json</p>
<p>{</p>
<p>  ‘id’:1,</p>
<p>  ‘test’:2,</p>
<p>  ‘test2’:3</p>
<p>}</p>
</blockquote>
</li>
</ol>
<p>现在的问题就是如何把他们合并？</p>
<p>第一个想法——暴力合并</p>
<ol>
<li>先读取A文件的一行数据，然后转化为json格式</li>
<li>将A某一行的json格式的数据同B文件中的数据一一校验，判断两个数据数据是否可以合并</li>
</ol>
<p>​        </p>
<p>这个想法的算法复杂度是o(a*b)，当文件的行数很大的时候，情况很堪忧。以我目前的处理的两个文件来说，两个文件都是9万多行。对于cpu来说，他最坏的时候需要90000 * 90000次指令。目前的cpu每秒大概能执行百万级的指令，那么执行这个合并操作也需要2个小时的时间</p>
<p>第二个方法-先预处理一下</p>
<p>我们可以先算出A文件中哪一行数据可以同B文件中哪几行的文件。因为合并的条件是唯一的。那么对于我们现在的处理的文件来说是算法复杂度为o(max(a,b))</p>
<p>但是这个算法还是有一个问题，当你已经知道两个文件哪俩行的文件需要合并的。你如何从这两个大文件中快速的读出这两行文件。</p>
<p>我目前的想法是记录每一行的偏移量的位置。</p>
<p>记录偏移量的话我刚开始是想采用以下代码的方法的。直接把文件中的数据读到内存中</p>
<p>执行以下代码,276M 需要2秒,17G 需要10秒</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_merge</span><span class="params">(filename)</span>:</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"start &#123;&#125; function is &#123;&#125;"</span>.format(test_merge.__name__, start_time)</span><br><span class="line">    </span><br><span class="line">    f = open(filename, <span class="string">"r"</span>)</span><br><span class="line">    line = []</span><br><span class="line">    line.append(<span class="number">0</span>)</span><br><span class="line">    filename_size = os.path.getsize(filename)</span><br><span class="line">    chars = f.read(filename_size)</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">        <span class="keyword">if</span> char == <span class="string">'\n'</span>:</span><br><span class="line">            line.append(count)</span><br><span class="line">        count = count + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>但是上面的代码在当文件很大的时候是很容易爆内存的.</p>
<p>所以在此我们可以采用第二个函数可以通过，先计算出每个文件的大小，然后每个读出根号大小的数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">merge_by_file</span><span class="params">(filename)</span>:</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"start &#123;&#125; function is &#123;&#125;"</span>.format(merge_by_file.__name__,start_time)</span><br><span class="line">    </span><br><span class="line">    f = open(filename, <span class="string">"r"</span>)</span><br><span class="line">    line = []</span><br><span class="line">    line.append(<span class="number">0</span>)</span><br><span class="line">    filename_size = os.path.getsize(filename)</span><br><span class="line">    filename_length = int(math.sqrt(filename_size))</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">print</span> filename_length</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(filename_length + <span class="number">2</span>):</span><br><span class="line">        <span class="keyword">if</span> count + filename_length &lt; filename_size:</span><br><span class="line">            chars = f.read(filename_length)</span><br><span class="line">            <span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">                count = count + <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> char == <span class="string">'\n'</span>:</span><br><span class="line">                    line.append(count)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            chars = f.read(filename_size - count)</span><br><span class="line">            <span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">                count = count + <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> char == <span class="string">'\n'</span> <span class="keyword">and</span> count != filename_size:</span><br><span class="line">                    line.append(count)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    f.close()</span><br></pre></td></tr></table></figure>



<p>由此，我在处理两个9万行文件的脚本每次运行的时间缩短到2分钟。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/07/%E6%8E%A2%E5%AF%BBpythin-%E4%B8%ADint-%E5%87%BD%E6%95%B0%E4%B8%AD%E7%9A%84%E4%B8%80%E7%82%B9%E5%B0%8F%E6%9B%B2%E6%8A%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/07/%E6%8E%A2%E5%AF%BBpythin-%E4%B8%ADint-%E5%87%BD%E6%95%B0%E4%B8%AD%E7%9A%84%E4%B8%80%E7%82%B9%E5%B0%8F%E6%9B%B2%E6%8A%98/" itemprop="url">探寻pythin 中int 函数中的一点小曲折</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-07T12:39:44+08:00">
                2020-03-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <pre><code>记探寻python 中int 函数中的一点小曲折</code></pre><p>​     今天在复习python 源码的时候.突然发现了一个奇怪的结果.代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">2</span>]: a = <span class="number">11111111111111111111111111</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: a = (int)(a)</span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: type(a)</span><br><span class="line">Out[<span class="number">4</span>]: long</span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: a = int(a)</span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: type(a)</span><br><span class="line">Out[<span class="number">6</span>]: long</span><br></pre></td></tr></table></figure>

<p>这个结果让我有点吃惊，刚开始我是以为是python 的强制类型转换的问题.因为在我之前的意识中一直觉的int 这个函数是类似于c中的强制类型转换。</p>
<p>接着我开始看了下这个函数的文档。粗略的看了下没发现啥有用的。接着在谷歌上搜寻答案,用了python 强制类型转换和 python 强制类型转换 源码 。。。等几个关键字，都没发现啥有营养的结果。</p>
<p>在搜索无果的情况下。只得求助stackoverflow 社区。幸得别人指点又跑回去重新看了下文档。发现文档在在中间其实写了这么一段 </p>
<p>If the argument is outside the integer range, the function returns a long object instead.</p>
<p>。。。 默默无语。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/07/epoll-poll-select/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/07/epoll-poll-select/" itemprop="url">epoll poll select</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-07T12:38:19+08:00">
                2020-03-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <pre><code>epoll,poll,select </code></pre><p>select 有文件描述符上的限制。默认的是1024 个连接. 只能告诉有几个文件描述符处于活动状态。无法告知cpu 具体是哪几个正在处于活动状态。时间复杂度度是o(n)</p>
<p>poll 因为采用了链表数据结构。没有文件描述符上的限制。剩下的和select 的弊端是一样的.</p>
<p>epoll 采用了红黑树和双链表的数据结构和回调机制。似的上面的弊端都解决掉了，时间复杂度是o(1).当然空间上的占用是更大了。用空间换时间。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/07/scary-%E8%B0%83%E5%BA%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/07/scary-%E8%B0%83%E5%BA%A6/" itemprop="url">scary 调度</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-07T12:36:58+08:00">
                2020-03-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>engine-&gt; 找到处理相关网站的spider -&gt;找到要爬的第一个url 请求-&gt;调度器用request 调度-&gt;获取到下一个要爬取的url返回给引擎-&gt;通过下载中间件转发给下载器。引擎从下载器中接收到response 然后通过spider 中间件发送给spider 处理。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/07/git-hook-%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/07/git-hook-%E6%80%BB%E7%BB%93/" itemprop="url">git hook 总结</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-07T12:35:37+08:00">
                2020-03-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Git Hooks 分为两类</p>
<p>1:客户端hook ,在提交者的计算机上被调用执行</p>
<p>2:服务端hook,在服务端上执行</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/06/golang-%E5%8F%AF%E6%AF%94%E8%BE%83%E7%B1%BB%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/06/golang-%E5%8F%AF%E6%AF%94%E8%BE%83%E7%B1%BB%E5%9E%8B/" itemprop="url">golang 可比较类型</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-06T14:13:53+08:00">
                2020-03-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <pre><code>The equality operators == and != apply to operands that are comparable. The ordering operators &lt;, &lt;=, &gt;, and &gt;= apply to operands that are ordered. These terms and the result of the comparisons are defined as follows:

Boolean values are comparable. Two boolean values are equal if they are either both true or both false.
Integer values are comparable and ordered, in the usual way.
Floating-point values are comparable and ordered, as defined by the IEEE-754 standard.
Complex values are comparable. Two complex values u and v are equal if both real(u) == real(v) and imag(u) == imag(v).
String values are comparable and ordered, lexically byte-wise.
Pointer values are comparable. Two pointer values are equal if they point to the same variable or if both have value nil. Pointers to distinct zero-size variables may or may not be equal.
Channel values are comparable. Two channel values are equal if they were created by the same call to make or if both have value nil.
Interface values are comparable. Two interface values are equal if they have identical dynamic types and equal dynamic values or if both have value nil.
A value x of non-interface type X and a value t of interface type T are comparable when values of type X are comparable and X implements T. They are equal if t&apos;s dynamic type is identical to X and t&apos;s dynamic value is equal to x.
Struct values are comparable if all their fields are comparable. Two struct values are equal if their corresponding non-blank fields are equal.
Array values are comparable if values of the array element type are comparable. Two array values are equal if their corresponding elements are equal.</code></pre><p>由上面可以看出以下几个基本类型是可比较类型的</p>
<ul>
<li>Boolean</li>
<li>Integer</li>
<li>Floating-point </li>
<li>Complex</li>
<li>String</li>
<li>Channel</li>
<li>Interface</li>
<li>Struct</li>
<li>Array(数组元素可以比较的话，那么就可以比较)</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><div id="refer-anchor-1"></div>

<ul>
<li>[1] <a href="https://golang.org/ref/spec#Comparison_operators" target="_blank" rel="noopener">go文档</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/05/go-context-%E4%B8%80%E7%82%B9%E6%BA%90%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/05/go-context-%E4%B8%80%E7%82%B9%E6%BA%90%E7%A0%81/" itemprop="url">go context 一点源码</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-05T15:01:38+08:00">
                2020-03-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><a href="#1">go 源码服务器环境</a></li>
<li><a href="#2">示例代码</a></li>
<li><a href="#3">代码流程解析</a></li>
</ul>
<h3 id="1">go 源码服务器环境</h3>

<ul>
<li><p>服务器: 阿里云的最低配的服务器</p>
</li>
<li><p>go version: go1.12.16</p>
</li>
<li><p>系统: centos7 linux/amd64</p>
</li>
</ul>
<h3 id="2">示例代码</h2>
    我们通过go官方给的一个学习context的例子来学习他的源码,[这个例子的地址](https://golang.org/pkg/context/)

<pre><code>gen := func(ctx context.Context) &lt;-chan int {
    // 返回一个int 类型的chan
    dst := make(chan int)
    n := 1
    go func() {
        for {
            select {
                // ctx.Done()返回的是一个chan
            case &lt;-ctx.Done():
                return // returning not to leak the goroutine
            case dst &lt;- n:
                n++
            }
        }
    }()
    return dst
}

ctx, cancel := context.WithCancel(context.Background())
defer cancel()
for n := range gen(ctx) {
    fmt.Println(n)
    if n == 5 {
        break
    }
}</code></pre><h3 id="#3">代码流程解析</h3>

<pre><code>context.Background() 返回是一个空的context
// ctx.done 函数 返回的是一个空struct 类型的chan 
func (c *cancelCtx) Done() &lt;-chan struct{} {
    c.mu.Lock()
    if c.done == nil {
        c.done = make(chan struct{})
    }
    d := c.done
    c.mu.Unlock()
    return d
}
//WithCancel 函数 返回的是一个Cancelctx 类型的变量ctx 和一个cancal function
func WithCancel(parent Context) (ctx Context, cancel CancelFunc) {
    c := newCancelCtx(parent)
    propagateCancel(parent, &amp;c)
    return &amp;c, func() { c.cancel(true, Canceled) }
}</code></pre><p>我们需要重点关注下propagateCancel函数和cancel 函数()</p>
<pre><code>if err == nil {
    panic(&quot;context: internal error: missing cancel error&quot;)
}
c.mu.Lock()
if c.err != nil {
    c.mu.Unlock()
    return // already canceled
}
c.err = err
if c.done == nil {
    c.done = closedchan
} else {
    close(c.done)
}
for child := range c.children {
    // NOTE: acquiring the child&apos;s lock while holding parent&apos;s lock.
    child.cancel(false, err)
}
c.children = nil
c.mu.Unlock()

if removeFromParent {
    removeChild(c.Context, c)
}</code></pre><p>由上面的源码我们可看到在cancel函数中,会关闭我们在c.done()中创建的c.done 这样就能安全的从线程之中退出了</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/22/go-%E4%B8%AD-make-%E5%92%8C-new-%E7%9A%84%E4%B8%80%E4%BA%9B%E5%8C%BA%E5%88%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/22/go-%E4%B8%AD-make-%E5%92%8C-new-%E7%9A%84%E4%B8%80%E4%BA%9B%E5%8C%BA%E5%88%AB/" itemprop="url">go 中 make 和 new 的一些区别</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-22T20:56:23+08:00">
                2020-02-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>make:</p>
<pre><code>这是是官方的源码上的注释文本,从上可以看出make 函数只能用于slice,map,和chan 数据结构的创建

The make built-in function allocates and initializes an object of typeslice, map, or chan (only). Like new, the first argument is a type, not avalue. </code></pre><p>new:</p>
<pre><code>这是new 函数的
The new built-in function allocates memory. The first argument is a type,not a value, and the value returned is a pointer to a newlyallocated zero value of that type.</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/20/go-chan-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/20/go-chan-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" itemprop="url">go_chan_源码解析</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-20T12:27:25+08:00">
                2020-02-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" itemprop="url" rel="index">
                    <span itemprop="name">源码解析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><a href="#1">go 源码服务器环境</a></li>
<li><a href="#2">chan 数据结构解析</a></li>
<li><a href="#3">makechan</a></li>
<li><a href="#4">chansend</a></li>
<li><a href="#5">chanrev</a><h3 id="1">go 源码服务器环境</h3>
</li>
</ul>
<ul>
<li><p>服务器: 阿里云的最低配的服务器</p>
</li>
<li><p>go version: go1.12.16</p>
</li>
<li><p>系统: centos7 linux/amd64</p>
</li>
</ul>
<h3 id="2">chan 数据结构解析</h3>

<p>chan 在go 源码中的数据结构是hchan ,其定义如下</p>
<pre><code>type hchan struct {
    qcount   uint           // 队列中数据的个数
    dataqsiz uint           // 队列中能容纳的数据个数
    buf      unsafe.Pointer // 队列首指针  整个chan 共用的一个数组
    elemsize uint16  // 数据单个元素大小
    closed   uint32 // 当前是否被关闭
    elemtype *_type // 元素类型
    sendx    uint   // 当前数组中的sendx 指针
    recvx    uint   // 当前
    recvq    waitq  // waitq 为等待线程队列
    sendq    waitq  // 
    lock mutex   //
}</code></pre><p>在上面的数据结构中,我们主要关注 <strong><code>buf</code></strong>。</br><br>hchan 中的队列本质上就是我们常见的链表。<br><code>buf 则就是指向链表头部的首指针。</code></br><br>想要<code>读取链表中的某一个元素主要就是通过 buf+recv 来实现的</code></br><br>想要往<code>链表中增加一个元素主要就是通过 buf+sendq 来实现的</code></br><br><font color="red">需要注意的是:在源码中读取链表数据额和增加链表数据这些都是通过unsafe.Pointer 直接操作内存地址的</font></p>
<h3 id="3">makechan</h3>
    在go 中常见的创建一个chan的代码

<pre><code>c := make(chan int,2)</code></pre><p>这个make 方法最后就是会触发makechan 方法<br><br>根据chan 中的数据类型和int 大小会有三种不同的处理办法。源码如下</p>
<pre><code>switch {
    // mem 为chan 数组元素预计占用的内存大小，比如我们在上面代码中设置了数组大小为2,我的测试机器是64位,int 占8个字节,所以mem=2*8=16
case mem == 0:
    c = (*hchan)(mallocgc(hchanSize, nil, true))
    // Race detector uses this location for synchronization.
    // 因为mem=0,此时buf 数组实际上就变成了容量为1的数组。
    c.buf = c.raceaddr()
    // 当chan 中的元素类型不包含指针时。上面的代码就会触发这个。
case elem.kind&amp;kindNoPointers != 0:
    // 为chan 申请内存。hchansize 是hchan 这个数据结构自己本身占的内存大小
    c = (*hchan)(mallocgc(hchanSize+mem, nil, true))
    // 初始化c.buf 让它指向指向链表头部
    c.buf = add(unsafe.Pointer(c), hchanSize)
default:
    // Elements contain pointers.
    c = new(hchan)
    c.buf = mallocgc(mem, elem, true)
}</code></pre><h3 id="4">chansend</h3>

<pre><code>c&lt;-1</code></pre><p>和makechan 类似,上面的代码通过解析器最后触发就是这个chansend 函数。<br><br>makechan 有2种写入方式。<br><br>1: 当c.recq 的队列中存在数据时(从源码上来看,队列最多只有一个元素)</p>
<pre><code>// 一般发生在队列容量已经满了,还在继续发送的时候
if sg := c.recvq.dequeue(); sg != nil {
    // Found a waiting receiver. We pass the value we want to send
    // directly to the receiver, bypassing the channel buffer (if any).
    send(c, sg, ep, func() { unlock(&amp;c.lock) }, 3)
    return true
}
// send 函数会触发sendDirectt 函数</code></pre><p>2:当队列容量未满的时候</p>
<pre><code>//当前队列容量未满的时候
if c.qcount &lt; c.dataqsiz {
    // Space is available in the channel buffer. Enqueue the element to send.
    // 通过c.buf+sendx 获取第sendx 个元素指针的起始地址
    qp := chanbuf(c, c.sendx)
    // 这里无视掉
    if raceenabled {
        raceacquire(qp)
        racerelease(qp)
    }
    // 将ep 的值复制给qp, ep 就是 c&lt;-1 中1的指针地址
    typedmemmove(c.elemtype, qp, ep)
    c.sendx++
    if c.sendx == c.dataqsiz {
        c.sendx = 0
    }
    c.qcount++
    unlock(&amp;c.lock)
    return true
}</code></pre><p><code>值得注意的是,当c.qcount == c.dataqsiz 时。会执行以下代码。会直接让当前协程加入到等待队列之中.代码如下</code></p>
<pre><code>gp := getg()
mysg := acquireSudog()
mysg.releasetime = 0
if t0 != 0 {
    mysg.releasetime = -1
}
// No stack splits between assigning elem and enqueuing mysg
// on gp.waiting where copystack can find it.
mysg.elem = ep
mysg.waitlink = nil
mysg.g = gp
mysg.isSelect = false
mysg.c = c
gp.waiting = mysg
println(&quot;chan_send 当前等待的内存地址是&quot;,mysg)
gp.param = nil
c.sendq.enqueue(mysg)
// 当前线程开始陷入沉睡
goparkunlock(&amp;c.lock, waitReasonChanSend, traceEvGoBlockSend, 3)</code></pre><h3 id="5">chanrev</h3>
下面代码会触发这个函数

<pre><code>t := &lt;-c</code></pre><p>和chansend 类似,也分2种模式</p>
<p>1:当前sendq 队列中存在数据,也就是会chansend 中那个被加入到等待队列中的协程。</p>
<pre><code>if sg := c.sendq.dequeue(); sg != nil {
    println(&quot;chan_rev sg 内存地址&quot;,sg)
    // Found a waiting sender. If buffer is size 0, receive value
    // directly from sender. Otherwise, receive from head of queue
    // and add sender&apos;s value to the tail of the queue (both map to
    // the same buffer slot because the queue is full).
    recv(c, sg, ep, func() { unlock(&amp;c.lock) }, 3)
    return true, true
}

recv 函数如下
qp := chanbuf(c, c.recvx)
if raceenabled {
    raceacquire(qp)
    racerelease(qp)
    raceacquireg(sg.g, qp)
    racereleaseg(sg.g, qp)
}
// copy data from queue to receiver
if ep != nil {
    // 将qp 的值复制给ep 。这里做了我们常见的一种办法
    typedmemmove(c.elemtype, ep, qp)
}
// copy data from sender to queue
typedmemmove(c.elemtype, qp, sg.elem)
c.recvx++
if c.recvx == c.dataqsiz {
    c.recvx = 0
}
c.sendx = c.recvx // c.sendx = (c.sendx+1) % c.dataqsiz</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg"
                alt="tygzx" />
            
              <p class="site-author-name" itemprop="name">tygzx</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tygzx</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
