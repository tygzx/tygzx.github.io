<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="知行合一">
<meta property="og:type" content="website">
<meta property="og:title" content="tygzx 的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="tygzx 的博客">
<meta property="og:description" content="知行合一">
<meta property="article:author" content="tygzx">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>tygzx 的博客</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">tygzx 的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/11/insert-command-%E6%B5%81%E7%A8%8B%E6%8E%A2%E7%A9%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/11/insert-command-%E6%B5%81%E7%A8%8B%E6%8E%A2%E7%A9%B6/" itemprop="url">insert command 流程探究</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-11T10:47:27+08:00">
                2020-03-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p><a href="#0">要探究的command</a></p>
</li>
<li><p><a href="#1">redis 版本</a></p>
</li>
<li><p><a href="#2">insert command 调用堆栈</a></p>
</li>
<li><p><a href="#3">inster command 流程图</a></p>
</li>
<li><p><a href="#4">client 数据结构</a></p>
</li>
<li><p><a href="#5">insert command code</a></p>
<h3 id="0">要探究的command</h3>

<p> LINSERT run before “redis” “redis1”</p>
<h3 id="1">redis 版本</h3>

<p> redis5.0 stable</p>
<h3 id="2">insert command 调用堆栈</h3>
</li>
</ul>
<ul>
<li>linsertCommand (src/t_list.c:269)<br></li>
<li>call (src/server.c:2468)<br></li>
<li>processCommand (src/server.c:2763)<br></li>
<li>processInputBuffer (src/networking.c:1466)<br></li>
<li>processInputBufferAndReplicate (src/networking.c:1501)<br></li>
<li>readQueryFromClient (src/networking.c:1583)<br></li>
<li>aeProcessEvents (src/ae.c:443)<br></li>
<li>aeMain (src/ae.c:501)<br></li>
<li>main (src/server.c:4235)<br></li>
</ul>
<h3 id="3">inster command 流程图</h3>

<p> <img src="https://upload-images.jianshu.io/upload_images/1250148-c97df494e2dc7bc3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Untitled Diagram.png"></p>
<h3 id="4">client 数据结构</h3>
这里只介绍几个和我们执行这几个命令比较相关的字段

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">client</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> id;            <span class="comment">/* Client incremental unique ID. */</span></span><br><span class="line">    <span class="keyword">int</span> fd;    <span class="comment">//文件描述符,主要是将返回的结果返回给界面             /* Client socket. </span></span><br><span class="line">    redisDb *db;            <span class="comment">/* Pointer to currently SELECTed DB. */</span></span><br><span class="line">    robj *name;             <span class="comment">/* As set by CLIENT SETNAME. */</span></span><br><span class="line">    sds querybuf;           <span class="comment">/* Buffer we use to accumulate client queries. */</span></span><br><span class="line">    <span class="keyword">size_t</span> qb_pos;          <span class="comment">/* The position we have read in querybuf. */</span></span><br><span class="line">    sds pending_querybuf;   <span class="comment">/* If this client is flagged as master, this buffer</span></span><br><span class="line"><span class="comment">                               represents the yet not applied portion of the</span></span><br><span class="line"><span class="comment">                               replication stream that we are receiving from</span></span><br><span class="line"><span class="comment">                               the master. */</span></span><br><span class="line">    <span class="keyword">size_t</span> querybuf_peak;   <span class="comment">/* Recent (100ms or more) peak of querybuf size. */</span></span><br><span class="line">    <span class="keyword">int</span> argc;               <span class="comment">/* Num of arguments of current command. */</span></span><br><span class="line">    robj **argv;            <span class="comment">/* Arguments of current command. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">redisCommand</span> *<span class="title">cmd</span>, *<span class="title">lastcmd</span>;</span>  <span class="comment">/* Last command executed. */</span></span><br><span class="line">    <span class="keyword">int</span> reqtype;            <span class="comment">/* Request protocol type: PROTO_REQ_* */</span></span><br><span class="line">    <span class="keyword">int</span> multibulklen;       <span class="comment">/* Number of multi bulk arguments left to read. */</span></span><br><span class="line">    <span class="keyword">long</span> bulklen;           <span class="comment">/* Length of bulk argument in multi bulk request. */</span></span><br><span class="line">    <span class="built_in">list</span> *reply;            <span class="comment">/* List of reply objects to send to the client. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> reply_bytes; <span class="comment">/* Tot bytes of objects in reply list. */</span></span><br><span class="line">    <span class="keyword">size_t</span> sentlen;         <span class="comment">/* Amount of bytes already sent in the current</span></span><br><span class="line"><span class="comment">                               buffer or object being sent. */</span></span><br><span class="line">    <span class="keyword">time_t</span> ctime;           <span class="comment">/* Client creation time. */</span></span><br><span class="line">    <span class="keyword">time_t</span> lastinteraction; <span class="comment">/* Time of the last interaction, used for timeout */</span></span><br><span class="line">    <span class="keyword">time_t</span> obuf_soft_limit_reached_time;</span><br><span class="line">    <span class="keyword">int</span> flags;              <span class="comment">/* Client flags: CLIENT_* macros. */</span></span><br><span class="line">    <span class="keyword">int</span> authenticated;      <span class="comment">/* When requirepass is non-NULL. */</span></span><br><span class="line">    <span class="keyword">int</span> replstate;          <span class="comment">/* Replication state if this is a slave. */</span></span><br><span class="line">    <span class="keyword">int</span> repl_put_online_on_ack; <span class="comment">/* Install slave write handler on first ACK. */</span></span><br><span class="line">    <span class="keyword">int</span> repldbfd;           <span class="comment">/* Replication DB file descriptor. */</span></span><br><span class="line">    <span class="keyword">off_t</span> repldboff;        <span class="comment">/* Replication DB file offset. */</span></span><br><span class="line">    <span class="keyword">off_t</span> repldbsize;       <span class="comment">/* Replication DB file size. */</span></span><br><span class="line">    sds replpreamble;       <span class="comment">/* Replication DB preamble. */</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> read_reploff; <span class="comment">/* Read replication offset if this is a master. */</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> reploff;      <span class="comment">/* Applied replication offset if this is a master. */</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> repl_ack_off; <span class="comment">/* Replication ack offset, if this is a slave. */</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> repl_ack_time;<span class="comment">/* Replication ack time, if this is a slave. */</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> psync_initial_offset; <span class="comment">/* FULLRESYNC reply offset other slaves</span></span><br><span class="line"><span class="comment">                                       copying this slave output buffer</span></span><br><span class="line"><span class="comment">                                       should use. */</span></span><br><span class="line">    <span class="keyword">char</span> replid[CONFIG_RUN_ID_SIZE+<span class="number">1</span>]; <span class="comment">/* Master replication ID (if master). */</span></span><br><span class="line">    <span class="keyword">int</span> slave_listening_port; <span class="comment">/* As configured with: SLAVECONF listening-port */</span></span><br><span class="line">    <span class="keyword">char</span> slave_ip[NET_IP_STR_LEN]; <span class="comment">/* Optionally given by REPLCONF ip-address */</span></span><br><span class="line">    <span class="keyword">int</span> slave_capa;         <span class="comment">/* Slave capabilities: SLAVE_CAPA_* bitwise OR. */</span></span><br><span class="line">    multiState mstate;      <span class="comment">/* MULTI/EXEC state */</span></span><br><span class="line">    <span class="keyword">int</span> btype;              <span class="comment">/* Type of blocking op if CLIENT_BLOCKED. */</span></span><br><span class="line">    blockingState bpop;     <span class="comment">/* blocking state */</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> woff;         <span class="comment">/* Last write global replication offset. */</span></span><br><span class="line">    <span class="built_in">list</span> *watched_keys;     <span class="comment">/* Keys WATCHED for MULTI/EXEC CAS */</span></span><br><span class="line">    dict *pubsub_channels;  <span class="comment">/* channels a client is interested in (SUBSCRIBE) */</span></span><br><span class="line">    <span class="built_in">list</span> *pubsub_patterns;  <span class="comment">/* patterns a client is interested in (SUBSCRIBE) */</span></span><br><span class="line">    sds peerid;             <span class="comment">/* Cached peer ID. */</span></span><br><span class="line">    listNode *client_list_node; <span class="comment">/* list node in client list */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Response buffer */</span></span><br><span class="line">    <span class="keyword">int</span> bufpos;</span><br><span class="line">    <span class="comment">// 返回的结果最终会写在buf数组里</span></span><br><span class="line">    <span class="keyword">char</span> buf[PROTO_REPLY_CHUNK_BYTES];</span><br><span class="line">&#125; client;</span><br></pre></td></tr></table></figure>
<h3 id="5">insert command code</h3>
    下面是执行这个command

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">linsertCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> where;</span><br><span class="line">    robj *subject;</span><br><span class="line">    listTypeIterator *iter;</span><br><span class="line">    listTypeEntry entry;</span><br><span class="line">    <span class="keyword">int</span> inserted = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 这里主要是解析参数</span></span><br><span class="line">    <span class="keyword">if</span> (strcasecmp(c-&gt;argv[<span class="number">2</span>]-&gt;ptr,<span class="string">"after"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        where = LIST_TAIL;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcasecmp(c-&gt;argv[<span class="number">2</span>]-&gt;ptr,<span class="string">"before"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        where = LIST_HEAD;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        addReply(c,shared.syntaxerr);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((subject = lookupKeyWriteOrReply(c,c-&gt;argv[<span class="number">1</span>],shared.czero)) == <span class="literal">NULL</span> ||</span><br><span class="line">        checkType(c,subject,OBJ_LIST)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Seek pivot from head to tail */</span></span><br><span class="line">    <span class="comment">// 从这里可以看出来这个是查找就是从头查找到尾的,时间复杂度为o(N)</span></span><br><span class="line">    iter = listTypeInitIterator(subject,<span class="number">0</span>,LIST_TAIL);</span><br><span class="line">    <span class="keyword">while</span> (listTypeNext(iter,&amp;entry)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (listTypeEqual(&amp;entry,c-&gt;argv[<span class="number">3</span>])) &#123;</span><br><span class="line">            listTypeInsert(&amp;entry,c-&gt;argv[<span class="number">4</span>],where);</span><br><span class="line">            inserted = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取链表的迭代器</span></span><br><span class="line">    listTypeReleaseIterator(iter);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inserted) &#123;</span><br><span class="line">        signalModifiedKey(c-&gt;db,c-&gt;argv[<span class="number">1</span>]);</span><br><span class="line">        notifyKeyspaceEvent(NOTIFY_LIST,<span class="string">"linsert"</span>,</span><br><span class="line">                            c-&gt;argv[<span class="number">1</span>],c-&gt;db-&gt;id);</span><br><span class="line">        server.dirty++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* Notify client of a failed insert */</span></span><br><span class="line">        addReply(c,shared.cnegone);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里是将插入后的结果写入到c-&gt;buf中</span></span><br><span class="line">    addReplyLongLong(c,listTypeLength(subject));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>




          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/11/%E8%A6%81%E6%8E%A2%E7%A9%B6%E7%9A%84command-0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/11/%E8%A6%81%E6%8E%A2%E7%A9%B6%E7%9A%84command-0/" itemprop="url"> * [要探究的command](#0)</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-11T10:46:49+08:00">
                2020-03-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/07/%E6%96%87%E4%BB%B6%E5%90%88%E5%B9%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/07/%E6%96%87%E4%BB%B6%E5%90%88%E5%B9%B6/" itemprop="url">文件合并</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-07T12:41:01+08:00">
                2020-03-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近碰到如下的一个问题  如何快速合并两个大文件？</p>
<p>有A,B两个文件。这两个文件都有以下特性</p>
<ol>
<li><p>A,B两个文件每一行都可以被解析为json 格式</p>
</li>
<li><p>A,B两个文件都比较大(至少大于500M)</p>
</li>
<li><p>A,B两个文件可以通过将每行转化为json之后通过某个相同key的值合并</p>
</li>
<li><p>A文件有a行,B文件有b行</p>
</li>
<li><p>A,B两个文件两行可以合并的条件是唯一的。</p>
<blockquote>
<p>比如 A文件的第一行可以是这样的一个json </p>
<p>{</p>
<p>​    ‘id’:1,</p>
<p>​    ‘test’: 2</p>
<p>}</p>
<p>B文件的第二行可以是这样的一个json</p>
<p>{</p>
<p>  ‘id’:1,</p>
<p>  ‘test2’:3</p>
<p>}</p>
<p>我们可以通过两个相同的key合并为这样一个json</p>
<p>{</p>
<p>  ‘id’:1,</p>
<p>  ‘test’:2,</p>
<p>  ‘test2’:3</p>
<p>}</p>
</blockquote>
</li>
</ol>
<p>现在的问题就是如何把他们合并？</p>
<p>第一个想法——暴力合并</p>
<ol>
<li>先读取A文件的一行数据，然后转化为json格式</li>
<li>将A某一行的json格式的数据同B文件中的数据一一校验，判断两个数据数据是否可以合并</li>
</ol>
<p>​        </p>
<p>这个想法的算法复杂度是o(a*b)，当文件的行数很大的时候，情况很堪忧。以我目前的处理的两个文件来说，两个文件都是9万多行。对于cpu来说，他最坏的时候需要90000 * 90000次指令。目前的cpu每秒大概能执行百万级的指令，那么执行这个合并操作也需要2个小时的时间</p>
<p>第二个方法-先预处理一下</p>
<p>我们可以先算出A文件中哪一行数据可以同B文件中哪几行的文件。因为合并的条件是唯一的。那么对于我们现在的处理的文件来说是算法复杂度为o(max(a,b))</p>
<p>但是这个算法还是有一个问题，当你已经知道两个文件哪俩行的文件需要合并的。你如何从这两个大文件中快速的读出这两行文件。</p>
<p>我目前的想法是记录每一行的偏移量的位置。</p>
<p>记录偏移量的话我刚开始是想采用以下代码的方法的。直接把文件中的数据读到内存中</p>
<p>执行以下代码,276M 需要2秒,17G 需要10秒</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_merge</span><span class="params">(filename)</span>:</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"start &#123;&#125; function is &#123;&#125;"</span>.format(test_merge.__name__, start_time)</span><br><span class="line">    </span><br><span class="line">    f = open(filename, <span class="string">"r"</span>)</span><br><span class="line">    line = []</span><br><span class="line">    line.append(<span class="number">0</span>)</span><br><span class="line">    filename_size = os.path.getsize(filename)</span><br><span class="line">    chars = f.read(filename_size)</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">        <span class="keyword">if</span> char == <span class="string">'\n'</span>:</span><br><span class="line">            line.append(count)</span><br><span class="line">        count = count + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>但是上面的代码在当文件很大的时候是很容易爆内存的.</p>
<p>所以在此我们可以采用第二个函数可以通过，先计算出每个文件的大小，然后每个读出根号大小的数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">merge_by_file</span><span class="params">(filename)</span>:</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"start &#123;&#125; function is &#123;&#125;"</span>.format(merge_by_file.__name__,start_time)</span><br><span class="line">    </span><br><span class="line">    f = open(filename, <span class="string">"r"</span>)</span><br><span class="line">    line = []</span><br><span class="line">    line.append(<span class="number">0</span>)</span><br><span class="line">    filename_size = os.path.getsize(filename)</span><br><span class="line">    filename_length = int(math.sqrt(filename_size))</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">print</span> filename_length</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(filename_length + <span class="number">2</span>):</span><br><span class="line">        <span class="keyword">if</span> count + filename_length &lt; filename_size:</span><br><span class="line">            chars = f.read(filename_length)</span><br><span class="line">            <span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">                count = count + <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> char == <span class="string">'\n'</span>:</span><br><span class="line">                    line.append(count)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            chars = f.read(filename_size - count)</span><br><span class="line">            <span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">                count = count + <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> char == <span class="string">'\n'</span> <span class="keyword">and</span> count != filename_size:</span><br><span class="line">                    line.append(count)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    f.close()</span><br></pre></td></tr></table></figure>



<p>由此，我在处理两个9万行文件的脚本每次运行的时间缩短到2分钟。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/07/%E6%8E%A2%E5%AF%BBpythin-%E4%B8%ADint-%E5%87%BD%E6%95%B0%E4%B8%AD%E7%9A%84%E4%B8%80%E7%82%B9%E5%B0%8F%E6%9B%B2%E6%8A%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/07/%E6%8E%A2%E5%AF%BBpythin-%E4%B8%ADint-%E5%87%BD%E6%95%B0%E4%B8%AD%E7%9A%84%E4%B8%80%E7%82%B9%E5%B0%8F%E6%9B%B2%E6%8A%98/" itemprop="url">探寻pythin 中int 函数中的一点小曲折</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-07T12:39:44+08:00">
                2020-03-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <pre><code>记探寻python 中int 函数中的一点小曲折</code></pre><p>​     今天在复习python 源码的时候.突然发现了一个奇怪的结果.代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">2</span>]: a = <span class="number">11111111111111111111111111</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: a = (int)(a)</span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: type(a)</span><br><span class="line">Out[<span class="number">4</span>]: long</span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: a = int(a)</span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: type(a)</span><br><span class="line">Out[<span class="number">6</span>]: long</span><br></pre></td></tr></table></figure>

<p>这个结果让我有点吃惊，刚开始我是以为是python 的强制类型转换的问题.因为在我之前的意识中一直觉的int 这个函数是类似于c中的强制类型转换。</p>
<p>接着我开始看了下这个函数的文档。粗略的看了下没发现啥有用的。接着在谷歌上搜寻答案,用了python 强制类型转换和 python 强制类型转换 源码 。。。等几个关键字，都没发现啥有营养的结果。</p>
<p>在搜索无果的情况下。只得求助stackoverflow 社区。幸得别人指点又跑回去重新看了下文档。发现文档在在中间其实写了这么一段 </p>
<p>If the argument is outside the integer range, the function returns a long object instead.</p>
<p>。。。 默默无语。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/07/epoll-poll-select/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/07/epoll-poll-select/" itemprop="url">epoll poll select</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-07T12:38:19+08:00">
                2020-03-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <pre><code>epoll,poll,select </code></pre><p>select 有文件描述符上的限制。默认的是1024 个连接. 只能告诉有几个文件描述符处于活动状态。无法告知cpu 具体是哪几个正在处于活动状态。时间复杂度度是o(n)</p>
<p>poll 因为采用了链表数据结构。没有文件描述符上的限制。剩下的和select 的弊端是一样的.</p>
<p>epoll 采用了红黑树和双链表的数据结构和回调机制。似的上面的弊端都解决掉了，时间复杂度是o(1).当然空间上的占用是更大了。用空间换时间。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/07/scary-%E8%B0%83%E5%BA%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/07/scary-%E8%B0%83%E5%BA%A6/" itemprop="url">scary 调度</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-07T12:36:58+08:00">
                2020-03-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>engine-&gt; 找到处理相关网站的spider -&gt;找到要爬的第一个url 请求-&gt;调度器用request 调度-&gt;获取到下一个要爬取的url返回给引擎-&gt;通过下载中间件转发给下载器。引擎从下载器中接收到response 然后通过spider 中间件发送给spider 处理。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/07/git-hook-%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/07/git-hook-%E6%80%BB%E7%BB%93/" itemprop="url">git hook 总结</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-07T12:35:37+08:00">
                2020-03-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Git Hooks 分为两类</p>
<p>1:客户端hook ,在提交者的计算机上被调用执行</p>
<p>2:服务端hook,在服务端上执行</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/06/golang-%E5%8F%AF%E6%AF%94%E8%BE%83%E7%B1%BB%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/06/golang-%E5%8F%AF%E6%AF%94%E8%BE%83%E7%B1%BB%E5%9E%8B/" itemprop="url">golang 可比较类型</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-06T14:13:53+08:00">
                2020-03-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <pre><code>The equality operators == and != apply to operands that are comparable. The ordering operators &lt;, &lt;=, &gt;, and &gt;= apply to operands that are ordered. These terms and the result of the comparisons are defined as follows:

Boolean values are comparable. Two boolean values are equal if they are either both true or both false.
Integer values are comparable and ordered, in the usual way.
Floating-point values are comparable and ordered, as defined by the IEEE-754 standard.
Complex values are comparable. Two complex values u and v are equal if both real(u) == real(v) and imag(u) == imag(v).
String values are comparable and ordered, lexically byte-wise.
Pointer values are comparable. Two pointer values are equal if they point to the same variable or if both have value nil. Pointers to distinct zero-size variables may or may not be equal.
Channel values are comparable. Two channel values are equal if they were created by the same call to make or if both have value nil.
Interface values are comparable. Two interface values are equal if they have identical dynamic types and equal dynamic values or if both have value nil.
A value x of non-interface type X and a value t of interface type T are comparable when values of type X are comparable and X implements T. They are equal if t&apos;s dynamic type is identical to X and t&apos;s dynamic value is equal to x.
Struct values are comparable if all their fields are comparable. Two struct values are equal if their corresponding non-blank fields are equal.
Array values are comparable if values of the array element type are comparable. Two array values are equal if their corresponding elements are equal.</code></pre><p>由上面可以看出以下几个基本类型是可比较类型的</p>
<ul>
<li>Boolean</li>
<li>Integer</li>
<li>Floating-point </li>
<li>Complex</li>
<li>String</li>
<li>Channel</li>
<li>Interface</li>
<li>Struct</li>
<li>Array(数组元素可以比较的话，那么就可以比较)</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><div id="refer-anchor-1"></div>

<ul>
<li>[1] <a href="https://golang.org/ref/spec#Comparison_operators" target="_blank" rel="noopener">go文档</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/05/go-context-%E4%B8%80%E7%82%B9%E6%BA%90%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/05/go-context-%E4%B8%80%E7%82%B9%E6%BA%90%E7%A0%81/" itemprop="url">go context 一点源码</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-05T15:01:38+08:00">
                2020-03-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><a href="#1">go 源码服务器环境</a></li>
<li><a href="#2">示例代码</a></li>
<li><a href="#3">代码流程解析</a></li>
</ul>
<h3 id="1">go 源码服务器环境</h3>

<ul>
<li><p>服务器: 阿里云的最低配的服务器</p>
</li>
<li><p>go version: go1.12.16</p>
</li>
<li><p>系统: centos7 linux/amd64</p>
</li>
</ul>
<h3 id="2">示例代码</h2>
    我们通过go官方给的一个学习context的例子来学习他的源码,[这个例子的地址](https://golang.org/pkg/context/)

<pre><code>gen := func(ctx context.Context) &lt;-chan int {
    // 返回一个int 类型的chan
    dst := make(chan int)
    n := 1
    go func() {
        for {
            select {
                // ctx.Done()返回的是一个chan
            case &lt;-ctx.Done():
                return // returning not to leak the goroutine
            case dst &lt;- n:
                n++
            }
        }
    }()
    return dst
}

ctx, cancel := context.WithCancel(context.Background())
defer cancel()
for n := range gen(ctx) {
    fmt.Println(n)
    if n == 5 {
        break
    }
}</code></pre><h3 id="#3">代码流程解析</h3>

<pre><code>context.Background() 返回是一个空的context
// ctx.done 函数 返回的是一个空struct 类型的chan 
func (c *cancelCtx) Done() &lt;-chan struct{} {
    c.mu.Lock()
    if c.done == nil {
        c.done = make(chan struct{})
    }
    d := c.done
    c.mu.Unlock()
    return d
}
//WithCancel 函数 返回的是一个Cancelctx 类型的变量ctx 和一个cancal function
func WithCancel(parent Context) (ctx Context, cancel CancelFunc) {
    c := newCancelCtx(parent)
    propagateCancel(parent, &amp;c)
    return &amp;c, func() { c.cancel(true, Canceled) }
}</code></pre><p>我们需要重点关注下propagateCancel函数和cancel 函数()</p>
<pre><code>if err == nil {
    panic(&quot;context: internal error: missing cancel error&quot;)
}
c.mu.Lock()
if c.err != nil {
    c.mu.Unlock()
    return // already canceled
}
c.err = err
if c.done == nil {
    c.done = closedchan
} else {
    close(c.done)
}
for child := range c.children {
    // NOTE: acquiring the child&apos;s lock while holding parent&apos;s lock.
    child.cancel(false, err)
}
c.children = nil
c.mu.Unlock()

if removeFromParent {
    removeChild(c.Context, c)
}</code></pre><p>由上面的源码我们可看到在cancel函数中,会关闭我们在c.done()中创建的c.done 这样就能安全的从线程之中退出了</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/22/go-%E4%B8%AD-make-%E5%92%8C-new-%E7%9A%84%E4%B8%80%E4%BA%9B%E5%8C%BA%E5%88%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tygzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tygzx 的博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/22/go-%E4%B8%AD-make-%E5%92%8C-new-%E7%9A%84%E4%B8%80%E4%BA%9B%E5%8C%BA%E5%88%AB/" itemprop="url">go 中 make 和 new 的一些区别</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-22T20:56:23+08:00">
                2020-02-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>make:</p>
<pre><code>这是是官方的源码上的注释文本,从上可以看出make 函数只能用于slice,map,和chan 数据结构的创建

The make built-in function allocates and initializes an object of typeslice, map, or chan (only). Like new, the first argument is a type, not avalue. </code></pre><p>new:</p>
<pre><code>这是new 函数的
The new built-in function allocates memory. The first argument is a type,not a value, and the value returned is a pointer to a newlyallocated zero value of that type.</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://img2.imgtn.bdimg.com/it/u=2129938840,5545132&fm=26&gp=0.jpg"
                alt="tygzx" />
            
              <p class="site-author-name" itemprop="name">tygzx</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tygzx</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
